"use client";

import Image from "next/image";
import Link from "next/link";
import AvatarPlaceholder from "./AvatarPlaceholder";
import { usePathname, useRouter } from "next/navigation";
import { useState } from "react";
import { useAppDispatch, useAppSelector } from "@/store/hooks";
import toast from "react-hot-toast";
import { logout, clearAuthStorage } from "@/store/slices/authSlice";

const AVATAR_PLACEHOLDER = "/avatar-placeholder.svg";

const navItems = [
  { href: "/", label: "Dashboard", icon: GridIcon },
  { href: "/subscription", label: "Subscription", icon: SubscriptionIcon },
  { href: "/settings", label: "Settings", icon: SettingsIcon },
];

function GridIcon({ active }: { active?: boolean }) {
  return (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M13.6903 19.4567C13.5 18.9973 13.5 18.4149 13.5 17.25C13.5 16.0851 13.5 15.5027 13.6903 15.0433C13.944 14.4307 14.4307 13.944 15.0433 13.6903C15.5027 13.5 16.0851 13.5 17.25 13.5C18.4149 13.5 18.9973 13.5 19.4567 13.6903C20.0693 13.944 20.556 14.4307 20.8097 15.0433C21 15.5027 21 16.0851 21 17.25C21 18.4149 21 18.9973 20.8097 19.4567C20.556 20.0693 20.0693 20.556 19.4567 20.8097C18.9973 21 18.4149 21 17.25 21C16.0851 21 15.5027 21 15.0433 20.8097C14.4307 20.556 13.944 20.0693 13.6903 19.4567Z" stroke="#3E8DB9" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round" />
      <path d="M13.6903 8.95671C13.5 8.49728 13.5 7.91485 13.5 6.75C13.5 5.58515 13.5 5.00272 13.6903 4.54329C13.944 3.93072 14.4307 3.44404 15.0433 3.1903C15.5027 3 16.0851 3 17.25 3C18.4149 3 18.9973 3 19.4567 3.1903C20.0693 3.44404 20.556 3.93072 20.8097 4.54329C21 5.00272 21 5.58515 21 6.75C21 7.91485 21 8.49728 20.8097 8.95671C20.556 9.56928 20.0693 10.056 19.4567 10.3097C18.9973 10.5 18.4149 10.5 17.25 10.5C16.0851 10.5 15.5027 10.5 15.0433 10.3097C14.4307 10.056 13.944 9.56928 13.6903 8.95671Z" stroke="#3E8DB9" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round" />
      <path d="M3.1903 19.4567C3 18.9973 3 18.4149 3 17.25C3 16.0851 3 15.5027 3.1903 15.0433C3.44404 14.4307 3.93072 13.944 4.54329 13.6903C5.00272 13.5 5.58515 13.5 6.75 13.5C7.91485 13.5 8.49728 13.5 8.95671 13.6903C9.56928 13.944 10.056 14.4307 10.3097 15.0433C10.5 15.5027 10.5 16.0851 10.5 17.25C10.5 18.4149 10.5 18.9973 10.3097 19.4567C10.056 20.0693 9.56928 20.556 8.95671 20.8097C8.49728 21 7.91485 21 6.75 21C5.58515 21 5.00272 21 4.54329 20.8097C3.93072 20.556 3.44404 20.0693 3.1903 19.4567Z" stroke="#3E8DB9" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round" />
      <path d="M3.1903 8.95671C3 8.49728 3 7.91485 3 6.75C3 5.58515 3 5.00272 3.1903 4.54329C3.44404 3.93072 3.93072 3.44404 4.54329 3.1903C5.00272 3 5.58515 3 6.75 3C7.91485 3 8.49728 3 8.95671 3.1903C9.56928 3.44404 10.056 3.93072 10.3097 4.54329C10.5 5.00272 10.5 5.58515 10.5 6.75C10.5 7.91485 10.5 8.49728 10.3097 8.95671C10.056 9.56928 9.56928 10.056 8.95671 10.3097C8.49728 10.5 7.91485 10.5 6.75 10.5C5.58515 10.5 5.00272 10.5 4.54329 10.3097C3.93072 10.056 3.44404 9.56928 3.1903 8.95671Z" stroke="#3E8DB9" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round" />
    </svg>

  );
}

function SubscriptionIcon({ active }: { active?: boolean }) {
  return (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <g clip-path="url(#clip0_356_2035)">
        <path d="M14.316 9.09698C14.1775 8.70742 13.9219 8.37019 13.5844 8.13145C13.2468 7.8927 12.8437 7.76411 12.4303 7.76327H10.8823C10.4407 7.76095 10.0138 7.92248 9.68441 8.21661C9.35497 8.51075 9.1463 8.91659 9.09874 9.35566C9.05119 9.79473 9.16813 10.2358 9.42696 10.5937C9.68579 10.9515 10.0681 11.2007 10.5 11.293L12.8571 11.8073C13.3391 11.9128 13.7651 12.1927 14.0532 12.5932C14.3414 12.9937 14.4714 13.4866 14.4182 13.9771C14.3651 14.4676 14.1325 14.9212 13.7653 15.2507C13.398 15.5802 12.922 15.7623 12.4286 15.7621H11.0966C10.2257 15.7621 9.48514 15.2067 9.21085 14.4301M11.7634 7.76327V5.7627M11.7634 17.7627V15.7638M3.42514 23.1404V18.8547H7.71085" stroke="#3E8DB9" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
        <path d="M22.9509 9.94925C23.406 12.3753 23.0426 14.8839 21.9178 17.0811C20.7931 19.2783 18.9706 21.0399 16.7364 22.0894C14.5022 23.1388 11.9827 23.4166 9.57353 22.8793C7.16433 22.342 5.00172 21.02 3.42514 19.1207M1.04914 14.0498C0.59404 11.6237 0.957385 9.11523 2.08215 6.91798C3.20691 4.72074 5.02942 2.95916 7.26363 1.90973C9.49783 0.860303 12.0173 0.582432 14.4265 1.11973C16.8357 1.65703 18.9983 2.97909 20.5749 4.8784" stroke="#3E8DB9" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
        <path d="M20.5749 0.860352V5.14607H16.2891" stroke="#3E8DB9" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
      </g>
      <defs>
        <clipPath id="clip0_356_2035">
          <rect width="24" height="24" fill="white" />
        </clipPath>
      </defs>
    </svg>

  );
}

function SettingsIcon({ active }: { active?: boolean }) {
  return (
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <mask id="path-1-inside-1_356_2038" fill="white">
        <path d="M8.702 1.94705C9.011 1.98905 9.24 2.16605 9.372 2.27705C9.512 2.39505 9.673 2.55505 9.844 2.72605L9.864 2.74605C11.031 3.91005 12.971 3.91005 14.138 2.74605L14.158 2.72605C14.329 2.55505 14.49 2.39505 14.629 2.27705C14.761 2.16605 14.99 1.98905 15.3 1.94705C15.584 1.90905 15.824 1.99205 15.987 2.06305C16.137 2.12905 16.306 2.22505 16.471 2.31905L18.245 3.32605C18.413 3.42105 18.585 3.51905 18.72 3.61505C18.865 3.71905 19.062 3.88405 19.176 4.15205C19.299 4.44305 19.259 4.73805 19.23 4.90805C19.198 5.09205 19.139 5.31805 19.076 5.56005L19.069 5.58805C18.673 7.11405 19.64 8.75505 21.206 9.17805L21.234 9.18505C21.471 9.24905 21.693 9.30905 21.867 9.37205C22.029 9.43105 22.301 9.54205 22.492 9.79205C22.668 10.021 22.715 10.273 22.733 10.451C22.75 10.615 22.75 10.812 22.75 11.003V12.994C22.75 13.185 22.75 13.382 22.733 13.546C22.715 13.724 22.668 13.976 22.492 14.205C22.301 14.455 22.029 14.566 21.867 14.625C21.693 14.688 21.471 14.748 21.234 14.812L21.206 14.819C19.641 15.241 18.674 16.882 19.071 18.409L19.078 18.437C19.141 18.679 19.2 18.905 19.231 19.089C19.261 19.259 19.301 19.553 19.177 19.845C19.064 20.112 18.867 20.278 18.721 20.382C18.586 20.478 18.414 20.575 18.247 20.67L16.472 21.678C16.308 21.771 16.139 21.867 15.988 21.933C15.825 22.005 15.585 22.088 15.301 22.049C14.992 22.008 14.763 21.83 14.631 21.719C14.491 21.602 14.33 21.441 14.159 21.271L14.139 21.25C12.972 20.086 11.03 20.086 9.862 21.251L9.842 21.271C9.671 21.441 9.511 21.602 9.371 21.719C9.239 21.83 9.01 22.008 8.701 22.049C8.416 22.088 8.176 22.005 8.013 21.933C7.863 21.868 7.694 21.771 7.53 21.678L5.755 20.67C5.587 20.575 5.415 20.478 5.28 20.382C5.135 20.278 4.937 20.113 4.824 19.845C4.701 19.553 4.741 19.259 4.77 19.089C4.802 18.905 4.861 18.679 4.924 18.437L4.931 18.409C5.327 16.883 4.36 15.241 2.794 14.819L2.766 14.812C2.529 14.748 2.307 14.688 2.133 14.625C1.971 14.566 1.699 14.455 1.508 14.205C1.332 13.976 1.285 13.724 1.267 13.546C1.25 13.382 1.25 13.185 1.25 12.994V12.965V11.032V11.003C1.25 10.812 1.25 10.615 1.267 10.451C1.285 10.273 1.332 10.021 1.508 9.79105C1.699 9.54205 1.971 9.43105 2.133 9.37205C2.307 9.30905 2.529 9.24905 2.766 9.18505L2.794 9.17805C4.361 8.75505 5.329 7.11405 4.932 5.58805L4.925 5.56005C4.862 5.31705 4.803 5.09205 4.772 4.90705C4.742 4.73705 4.703 4.44305 4.826 4.15105C4.939 3.88405 5.136 3.71905 5.282 3.61505C5.417 3.51905 5.589 3.42105 5.756 3.32605L5.782 3.31205L7.506 2.33305L7.531 2.31905C7.695 2.22505 7.865 2.12905 8.015 2.06305C8.178 1.99205 8.418 1.90905 8.702 1.94705ZM8.247 3.63705L6.522 4.61605C6.425 4.67105 6.349 4.71505 6.285 4.75305L6.272 4.76105C6.295 4.86705 6.332 5.00805 6.384 5.21105C6.994 7.56005 5.519 9.99705 3.184 10.626C2.989 10.679 2.853 10.716 2.752 10.747L2.751 10.76C2.75 10.834 2.75 10.921 2.75 11.032V12.965C2.75 13.076 2.75 13.162 2.751 13.237L2.752 13.25C2.853 13.281 2.989 13.318 3.184 13.371C5.519 14 6.993 16.437 6.383 18.786C6.33 18.988 6.294 19.13 6.27 19.236L6.283 19.244C6.348 19.282 6.424 19.325 6.521 19.38L8.245 20.36C8.34 20.413 8.415 20.456 8.479 20.491L8.489 20.496C8.565 20.426 8.663 20.328 8.803 20.189C10.556 18.44 13.446 18.44 15.199 20.189C15.338 20.328 15.437 20.426 15.512 20.496L15.522 20.491C15.587 20.456 15.661 20.413 15.756 20.359L17.481 19.38C17.578 19.325 17.654 19.282 17.719 19.244L17.732 19.236C17.708 19.13 17.671 18.988 17.619 18.786C17.008 16.437 18.481 14 20.816 13.371C21.011 13.318 21.147 13.281 21.248 13.25L21.249 13.237C21.25 13.162 21.25 13.076 21.25 12.965V11.032C21.25 10.921 21.25 10.834 21.249 10.76L21.248 10.747C21.147 10.716 21.011 10.679 20.816 10.626C18.481 9.99605 17.007 7.56005 17.617 5.21105C17.67 5.00805 17.706 4.86705 17.73 4.76105L17.717 4.75305C17.652 4.71505 17.576 4.67105 17.479 4.61705L15.755 3.63705C15.66 3.58305 15.585 3.54105 15.521 3.50605L15.51 3.50105C15.435 3.57105 15.337 3.66905 15.197 3.80805C13.445 5.55605 10.557 5.55605 8.805 3.80805C8.665 3.66805 8.567 3.57105 8.491 3.50005L8.481 3.50605C8.416 3.54105 8.342 3.58305 8.247 3.63705ZM12 7.75005C14.347 7.75005 16.25 9.65305 16.25 12C16.25 14.347 14.347 16.25 12 16.25C9.653 16.25 7.75 14.347 7.75 12C7.75 9.65305 9.653 7.75005 12 7.75005ZM9.25 12C9.25 13.519 10.481 14.75 12 14.75C13.519 14.75 14.75 13.519 14.75 12C14.75 10.481 13.519 9.25005 12 9.25005C10.481 9.25005 9.25 10.481 9.25 12Z" />
      </mask>
      <path d="M8.702 1.94705C9.011 1.98905 9.24 2.16605 9.372 2.27705C9.512 2.39505 9.673 2.55505 9.844 2.72605L9.864 2.74605C11.031 3.91005 12.971 3.91005 14.138 2.74605L14.158 2.72605C14.329 2.55505 14.49 2.39505 14.629 2.27705C14.761 2.16605 14.99 1.98905 15.3 1.94705C15.584 1.90905 15.824 1.99205 15.987 2.06305C16.137 2.12905 16.306 2.22505 16.471 2.31905L18.245 3.32605C18.413 3.42105 18.585 3.51905 18.72 3.61505C18.865 3.71905 19.062 3.88405 19.176 4.15205C19.299 4.44305 19.259 4.73805 19.23 4.90805C19.198 5.09205 19.139 5.31805 19.076 5.56005L19.069 5.58805C18.673 7.11405 19.64 8.75505 21.206 9.17805L21.234 9.18505C21.471 9.24905 21.693 9.30905 21.867 9.37205C22.029 9.43105 22.301 9.54205 22.492 9.79205C22.668 10.021 22.715 10.273 22.733 10.451C22.75 10.615 22.75 10.812 22.75 11.003V12.994C22.75 13.185 22.75 13.382 22.733 13.546C22.715 13.724 22.668 13.976 22.492 14.205C22.301 14.455 22.029 14.566 21.867 14.625C21.693 14.688 21.471 14.748 21.234 14.812L21.206 14.819C19.641 15.241 18.674 16.882 19.071 18.409L19.078 18.437C19.141 18.679 19.2 18.905 19.231 19.089C19.261 19.259 19.301 19.553 19.177 19.845C19.064 20.112 18.867 20.278 18.721 20.382C18.586 20.478 18.414 20.575 18.247 20.67L16.472 21.678C16.308 21.771 16.139 21.867 15.988 21.933C15.825 22.005 15.585 22.088 15.301 22.049C14.992 22.008 14.763 21.83 14.631 21.719C14.491 21.602 14.33 21.441 14.159 21.271L14.139 21.25C12.972 20.086 11.03 20.086 9.862 21.251L9.842 21.271C9.671 21.441 9.511 21.602 9.371 21.719C9.239 21.83 9.01 22.008 8.701 22.049C8.416 22.088 8.176 22.005 8.013 21.933C7.863 21.868 7.694 21.771 7.53 21.678L5.755 20.67C5.587 20.575 5.415 20.478 5.28 20.382C5.135 20.278 4.937 20.113 4.824 19.845C4.701 19.553 4.741 19.259 4.77 19.089C4.802 18.905 4.861 18.679 4.924 18.437L4.931 18.409C5.327 16.883 4.36 15.241 2.794 14.819L2.766 14.812C2.529 14.748 2.307 14.688 2.133 14.625C1.971 14.566 1.699 14.455 1.508 14.205C1.332 13.976 1.285 13.724 1.267 13.546C1.25 13.382 1.25 13.185 1.25 12.994V12.965V11.032V11.003C1.25 10.812 1.25 10.615 1.267 10.451C1.285 10.273 1.332 10.021 1.508 9.79105C1.699 9.54205 1.971 9.43105 2.133 9.37205C2.307 9.30905 2.529 9.24905 2.766 9.18505L2.794 9.17805C4.361 8.75505 5.329 7.11405 4.932 5.58805L4.925 5.56005C4.862 5.31705 4.803 5.09205 4.772 4.90705C4.742 4.73705 4.703 4.44305 4.826 4.15105C4.939 3.88405 5.136 3.71905 5.282 3.61505C5.417 3.51905 5.589 3.42105 5.756 3.32605L5.782 3.31205L7.506 2.33305L7.531 2.31905C7.695 2.22505 7.865 2.12905 8.015 2.06305C8.178 1.99205 8.418 1.90905 8.702 1.94705ZM8.247 3.63705L6.522 4.61605C6.425 4.67105 6.349 4.71505 6.285 4.75305L6.272 4.76105C6.295 4.86705 6.332 5.00805 6.384 5.21105C6.994 7.56005 5.519 9.99705 3.184 10.626C2.989 10.679 2.853 10.716 2.752 10.747L2.751 10.76C2.75 10.834 2.75 10.921 2.75 11.032V12.965C2.75 13.076 2.75 13.162 2.751 13.237L2.752 13.25C2.853 13.281 2.989 13.318 3.184 13.371C5.519 14 6.993 16.437 6.383 18.786C6.33 18.988 6.294 19.13 6.27 19.236L6.283 19.244C6.348 19.282 6.424 19.325 6.521 19.38L8.245 20.36C8.34 20.413 8.415 20.456 8.479 20.491L8.489 20.496C8.565 20.426 8.663 20.328 8.803 20.189C10.556 18.44 13.446 18.44 15.199 20.189C15.338 20.328 15.437 20.426 15.512 20.496L15.522 20.491C15.587 20.456 15.661 20.413 15.756 20.359L17.481 19.38C17.578 19.325 17.654 19.282 17.719 19.244L17.732 19.236C17.708 19.13 17.671 18.988 17.619 18.786C17.008 16.437 18.481 14 20.816 13.371C21.011 13.318 21.147 13.281 21.248 13.25L21.249 13.237C21.25 13.162 21.25 13.076 21.25 12.965V11.032C21.25 10.921 21.25 10.834 21.249 10.76L21.248 10.747C21.147 10.716 21.011 10.679 20.816 10.626C18.481 9.99605 17.007 7.56005 17.617 5.21105C17.67 5.00805 17.706 4.86705 17.73 4.76105L17.717 4.75305C17.652 4.71505 17.576 4.67105 17.479 4.61705L15.755 3.63705C15.66 3.58305 15.585 3.54105 15.521 3.50605L15.51 3.50105C15.435 3.57105 15.337 3.66905 15.197 3.80805C13.445 5.55605 10.557 5.55605 8.805 3.80805C8.665 3.66805 8.567 3.57105 8.491 3.50005L8.481 3.50605C8.416 3.54105 8.342 3.58305 8.247 3.63705ZM12 7.75005C14.347 7.75005 16.25 9.65305 16.25 12C16.25 14.347 14.347 16.25 12 16.25C9.653 16.25 7.75 14.347 7.75 12C7.75 9.65305 9.653 7.75005 12 7.75005ZM9.25 12C9.25 13.519 10.481 14.75 12 14.75C13.519 14.75 14.75 13.519 14.75 12C14.75 10.481 13.519 9.25005 12 9.25005C10.481 9.25005 9.25 10.481 9.25 12Z" fill="#3E8DB9" stroke="#3E8DB9" stroke-width="2" mask="url(#path-1-inside-1_356_2038)" />
    </svg>

  );
}

export default function Sidebar() {
  const pathname = usePathname();
  const router = useRouter();
  const dispatch = useAppDispatch();
  const [mobileOpen, setMobileOpen] = useState(false);
  const adminSettings = useAppSelector((s) => s.adminSettings.data);
  const authUser = useAppSelector((s) => s.auth.user);
  const settingsImage = adminSettings?.image;
  const profileImage =
    adminSettings != null && (settingsImage == null || settingsImage === "")
      ? AVATAR_PLACEHOLDER
      : (settingsImage || authUser?.profileImage || AVATAR_PLACEHOLDER);

  function handleLogout() {
    dispatch(logout());
    clearAuthStorage();
    toast.success("Logged out successfully");
    setMobileOpen(false);
    router.replace("/login");
  }

  const sidebar = (
    <aside className="flex h-full w-64 flex-col bg-[#F8FAFC] border-r border-gray-200/80">
      <div className="flex h-16 items-center justify-between gap-2 border-b border-gray-200/80 px-5">
        <Image src="/logo.png" alt="Logo" width={40} height={40} className="shrink-0" />
        <button
          type="button"
          onClick={() => setMobileOpen(false)}
          className="p-2 text-gray-600 hover:text-gray-900 md:hidden"
          aria-label="Close menu"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>
      <nav className="flex-1 space-y-1 p-4">
        {navItems.map(({ href, label, icon: Icon }) => {
          const active = pathname === href;
          return (
            <Link
              key={href}
              href={href}
              onClick={() => setMobileOpen(false)}
              className={`flex items-center gap-3 rounded-xl px-4 py-3 text-base font-semibold transition-colors ${active
                  ? "bg-[#D0E3F5] text-[#1e5a9e]"
                  : "text-gray-600 hover:bg-gray-100 hover:text-gray-900"
                }`}
            >
              <Icon active={active} />
              {label}
            </Link>
          );
        })}
      </nav>
      <div className="border-t border-gray-200/80 p-4">
        <div className="flex items-center gap-3 px-1 py-2">
          <div className="relative h-11 w-11 shrink-0 overflow-hidden rounded-full bg-gray-200">
            {profileImage === AVATAR_PLACEHOLDER ? (
              <AvatarPlaceholder className="absolute inset-0 h-full w-full" />
            ) : (
              <Image
                src={profileImage}
                alt="Profile"
                fill
                sizes="44px"
                className="object-cover"
              />
            )}
          </div>
          <button
            type="button"
            onClick={handleLogout}
            className="flex flex-1 cursor-pointer items-center justify-center gap-2 rounded-full border border-red-500 bg-white px-4 py-3 text-base font-medium text-red-500 transition-colors hover:bg-red-50"
          >
            Logout
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </button>
        </div>
      </div>
    </aside>
  );

  return (
    <>
      <button
        type="button"
        onClick={() => setMobileOpen(true)}
        className="fixed left-4 top-4 z-50 flex h-10 w-10 items-center justify-center rounded-lg bg-[#F8FAFC] text-gray-700 shadow md:hidden"
        aria-label="Open menu"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M3 12h18M3 6h18M3 18h18" />
        </svg>
      </button>
      {mobileOpen && (
        <div
          className="fixed inset-0 z-40 bg-black/50 md:hidden"
          onClick={() => setMobileOpen(false)}
          aria-hidden
        />
      )}
      <div
        className={`fixed inset-y-0 left-0 z-40 w-64 transform transition-transform md:translate-x-0 ${
          mobileOpen ? "translate-x-0" : "-translate-x-full"
        }`}
      >
        {sidebar}
      </div>
    </>
  );
}